name: JARVIS Postman API Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'postman/**'
      - 'backend/**/*.py'
      - '.github/workflows/postman-api-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'postman/**'
      - 'backend/**/*.py'
  workflow_dispatch:
    inputs:
      collection:
        description: 'Collection to run (all, voice-auth, voice-unlock, api)'
        required: false
        default: 'all'
      environment:
        description: 'Environment to use'
        required: false
        default: 'local'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Validation job - runs quickly to catch issues early
  validate-collections:
    name: Validate Postman Collections
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Validate collection JSON syntax
        run: |
          echo "ðŸ” Validating Postman collection files..."
          for file in postman/collections/*.json; do
            echo "Checking $file..."
            python3 -c "import json; json.load(open('$file'))" || exit 1
          done
          echo "âœ… All collection files are valid JSON"

      - name: Validate environment JSON syntax
        run: |
          echo "ðŸ” Validating Postman environment files..."
          for file in postman/environments/*.json; do
            echo "Checking $file..."
            python3 -c "import json; json.load(open('$file'))" || exit 1
          done
          echo "âœ… All environment files are valid JSON"

  # Run API tests against mock server
  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    needs: validate-collections
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Cache Python dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn httpx pytest

      - name: Start mock API server
        run: |
          # Create a simple mock server for testing
          cat > /tmp/mock_server.py << 'EOF'
          from fastapi import FastAPI
          from fastapi.responses import JSONResponse
          import uvicorn

          app = FastAPI()

          @app.get("/health")
          def health():
              return {"status": "healthy", "version": "test"}

          @app.get("/api/voice-auth-intelligence/health")
          def voice_auth_health():
              return {"status": "healthy", "components": {"langgraph": "ok", "langfuse": "ok"}}

          @app.get("/api/voice-auth-intelligence/status")
          def voice_auth_status():
              return {
                  "status": "operational",
                  "components": {
                      "calibration": "ready",
                      "anti_spoofing": "ready",
                      "fine_tuning": "ready"
                  }
              }

          @app.post("/api/voice-auth-intelligence/audit/session/start")
          def start_audit():
              return {"session_id": "test-session-123", "success": True}

          @app.post("/api/voice-auth-intelligence/audit/session/end")
          def end_audit():
              return {"success": True}

          @app.post("/api/voice-auth-intelligence/anti-spoofing/comprehensive")
          def anti_spoofing():
              return {
                  "is_spoofed": False,
                  "overall_spoof_confidence": 0.05,
                  "checks": {
                      "replay_attack": False,
                      "synthesis_attack": False,
                      "voice_conversion": False,
                      "environmental_anomaly": False
                  }
              }

          @app.post("/api/voice-auth-intelligence/anti-spoofing/test-full-pipeline")
          def anti_spoofing_test():
              return {
                  "scenario": "legitimate",
                  "overall_result": {
                      "is_spoofed": False,
                      "recommendation": "ALLOW"
                  }
              }

          @app.post("/api/voice-auth-intelligence/calibration/authenticate")
          def calibrated_auth():
              return {
                  "authenticated": True,
                  "raw_score": 0.88,
                  "calibrated_probability": 0.92,
                  "threshold_used": 0.40,
                  "security_level": "base",
                  "embedding_evaluation": {"classification": "owner"}
              }

          @app.post("/api/voice-auth-intelligence/calibration/add-sample")
          def add_sample():
              return {"success": True, "total_samples": 50}

          @app.get("/api/voice-auth-intelligence/calibration/status")
          def calibration_status():
              return {
                  "summary": "Calibration in progress",
                  "recommendation": "Continue collecting samples",
                  "progress_report": {"progress_percent": 45}
              }

          @app.get("/api/voice-auth-intelligence/calibration/thresholds")
          def thresholds():
              return {
                  "current_thresholds": {"base": 0.40, "high": 0.60, "critical": 0.75},
                  "target_thresholds": {"base": 0.90, "high": 0.95, "critical": 0.98},
                  "progress_percent": 44.4,
                  "performance_metrics": {"frr": 0.02, "far": 0.01}
              }

          @app.post("/api/voice-auth-intelligence/fusion/calculate")
          def fusion():
              return {"fused_confidence": 0.85, "authenticated": True}

          @app.post("/api/screen/unlock")
          def unlock():
              return {"success": True, "method": "keychain"}

          @app.post("/voice/jarvis/speak")
          def speak():
              return {"success": True, "message": "Speech queued"}

          @app.get("/api/voice-auth-intelligence/test/threshold-progress")
          def threshold_progress():
              return {
                  "journey_to_90_percent": {"progress_visual": "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%"},
                  "calibration": {"quality": "good", "samples_collected": 75},
                  "summary": "Making good progress"
              }

          if __name__ == "__main__":
              uvicorn.run(app, host="0.0.0.0", port=8010)
          EOF

          python /tmp/mock_server.py &
          sleep 5
          echo "âœ… Mock server started"

      - name: Wait for server
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8010/health > /dev/null; then
              echo "âœ… Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done

      - name: Run Voice Auth Intelligence Collection
        if: github.event.inputs.collection == 'all' || github.event.inputs.collection == 'voice-auth' || github.event.inputs.collection == ''
        run: |
          newman run postman/collections/JARVIS_Voice_Auth_Intelligence_Collection.postman_collection.json \
            --env-var "base_url=http://localhost:8010" \
            --env-var "speaker_name=Derek" \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export ./reports/voice-auth-intelligence-report.html \
            --reporter-htmlextra-title "JARVIS Voice Auth Intelligence Tests" \
            --delay-request 100 \
            --timeout-request 10000 \
            --folder "1. System Status" \
            --folder "2. Calibration System" || true

      - name: Run Voice Unlock Flow Collection
        if: github.event.inputs.collection == 'all' || github.event.inputs.collection == 'voice-unlock' || github.event.inputs.collection == ''
        run: |
          newman run postman/collections/JARVIS_Voice_Unlock_Flow_Collection.postman_collection.json \
            --env-var "base_url=http://localhost:8010" \
            --env-var "speaker_name=Derek" \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export ./reports/voice-unlock-flow-report.html \
            --reporter-htmlextra-title "JARVIS Voice Unlock Flow Tests" \
            --delay-request 100 \
            --timeout-request 10000 || true

      - name: Run API Collection Health Checks
        if: github.event.inputs.collection == 'all' || github.event.inputs.collection == 'api' || github.event.inputs.collection == ''
        run: |
          newman run postman/collections/JARVIS_API_Collection.postman_collection.json \
            --env-var "base_url=http://localhost:8010" \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export ./reports/api-collection-report.html \
            --reporter-htmlextra-title "JARVIS API Tests" \
            --delay-request 100 \
            --timeout-request 10000 \
            --folder "Health & Status" || true

      - name: Upload test reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: newman-reports
          path: reports/
          retention-days: 30

  # Security scan for API collections
  security-scan:
    name: Security Scan Collections
    runs-on: ubuntu-latest
    needs: validate-collections
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for secrets in collections
        run: |
          echo "ðŸ” Scanning collections for potential secrets..."

          # Check for common secret patterns
          PATTERNS=(
            'password.*:.*"[^"]+[a-zA-Z0-9]+"'
            'api[_-]?key.*:.*"[^"]+"'
            'secret.*:.*"[^"]+"'
            'token.*:.*"[a-zA-Z0-9_-]+"'
            'bearer.*[a-zA-Z0-9_-]+'
          )

          FOUND_ISSUES=0

          for pattern in "${PATTERNS[@]}"; do
            if grep -rniE "$pattern" postman/collections/ 2>/dev/null | grep -v '""' | grep -v 'description'; then
              echo "âš ï¸ Potential secret found matching pattern: $pattern"
              FOUND_ISSUES=$((FOUND_ISSUES + 1))
            fi
          done

          if [ $FOUND_ISSUES -gt 0 ]; then
            echo "âš ï¸ Found $FOUND_ISSUES potential issues. Please review."
          else
            echo "âœ… No obvious secrets found in collections"
          fi

      - name: Validate no sensitive environment values
        run: |
          echo "ðŸ” Checking environment files for sensitive values..."

          # Check that environment files don't contain actual secrets
          if grep -rE '"value":\s*"[a-zA-Z0-9]{20,}"' postman/environments/ 2>/dev/null | grep -v 'localhost' | grep -v 'base_url'; then
            echo "âš ï¸ Environment file may contain long values that could be secrets"
          else
            echo "âœ… Environment files look clean"
          fi

  # Generate collection documentation
  generate-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    needs: validate-collections
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install documentation tools
        run: npm install -g openapi-to-postmanv2

      - name: Generate collection summary
        run: |
          echo "# JARVIS Postman Collections Summary" > postman/COLLECTIONS_SUMMARY.md
          echo "" >> postman/COLLECTIONS_SUMMARY.md
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> postman/COLLECTIONS_SUMMARY.md
          echo "" >> postman/COLLECTIONS_SUMMARY.md

          for file in postman/collections/*.json; do
            name=$(python3 -c "import json; print(json.load(open('$file'))['info']['name'])")
            desc=$(python3 -c "import json; d=json.load(open('$file'))['info'].get('description','No description'); print(d[:200] + '...' if len(d) > 200 else d)" 2>/dev/null || echo "No description")

            echo "## $name" >> postman/COLLECTIONS_SUMMARY.md
            echo "" >> postman/COLLECTIONS_SUMMARY.md
            echo "$desc" >> postman/COLLECTIONS_SUMMARY.md
            echo "" >> postman/COLLECTIONS_SUMMARY.md
            echo "**File:** \`$(basename $file)\`" >> postman/COLLECTIONS_SUMMARY.md
            echo "" >> postman/COLLECTIONS_SUMMARY.md
          done

          cat postman/COLLECTIONS_SUMMARY.md

      - name: Upload documentation
        uses: actions/upload-artifact@v6
        with:
          name: postman-docs
          path: postman/COLLECTIONS_SUMMARY.md
          retention-days: 30
