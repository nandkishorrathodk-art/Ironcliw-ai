name: Sync Learning Databases

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_full_sync:
        description: 'Force full sync (not just incremental)'
        required: false
        default: 'false'

jobs:
  sync:
    name: Sync Local â†’ GCP Learning Data
    runs-on: ubuntu-latest
    outputs:
      vm_exists: ${{ steps.check_vm.outputs.vm_exists }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install aiosqlite pyyaml

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Export Local Learning Data
        run: |
          # This would run on a local machine with access to ~/.jarvis/
          # For now, we'll fetch from GCP and aggregate
          echo "ðŸ“Š Preparing to sync learning databases..."
          echo "Mode: ${{ github.event.inputs.force_full_sync || 'incremental' }}"

      - name: Check if GCP VM exists
        id: check_vm
        run: |
          # Check if any JARVIS VMs are running
          VM_COUNT=$(gcloud compute instances list \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --filter="name~'jarvis-auto-.*' AND status=RUNNING" \
            --format="value(name)" | wc -l)

          if [ "$VM_COUNT" -eq 0 ]; then
            echo "âš ï¸  No JARVIS VMs currently running"
            echo "vm_exists=false" >> $GITHUB_OUTPUT
          else
            VM_NAME=$(gcloud compute instances list \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --filter="name~'jarvis-auto-.*' AND status=RUNNING" \
              --format="value(name)" | head -n1)
            VM_ZONE=$(gcloud compute instances list \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --filter="name~'jarvis-auto-.*' AND status=RUNNING" \
              --format="value(zone)" | head -n1)

            echo "âœ… Found VM: $VM_NAME in $VM_ZONE"
            echo "vm_exists=true" >> $GITHUB_OUTPUT
            echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
            echo "vm_zone=$VM_ZONE" >> $GITHUB_OUTPUT
          fi

      - name: Sync to GCP
        if: steps.check_vm.outputs.vm_exists == 'true'
        run: |
          gcloud compute ssh ${{ steps.check_vm.outputs.vm_name }} \
            --zone=${{ steps.check_vm.outputs.vm_zone }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --command='bash -s' <<'ENDSSH'
          set -e

          echo "ðŸ”„ Starting database sync..."

          cd ~/backend/backend

          # Create sync script
          cat > sync_databases.py << 'PYTHON_SCRIPT'
          #!/usr/bin/env python3
          """
          Database Sync Script - Aggregates learning data from multiple sources
          """
          import asyncio
          import sys
          import os
          from pathlib import Path
          from datetime import datetime, timedelta

          # Add backend to path
          sys.path.insert(0, str(Path(__file__).parent))

          async def sync_databases():
              print("ðŸ—„ï¸ Database Sync Starting...")
              print(f"Timestamp: {datetime.now().isoformat()}")
              print("=" * 60)

              try:
                  from intelligence.learning_database import get_learning_database

                  # Get database instance
                  db = await get_learning_database()

                  # Get metrics
                  metrics = await db.get_learning_metrics()

                  print("\nðŸ“Š Current Learning Statistics:")
                  print(f"   Total Goals: {metrics['goals']['total_goals']}")
                  print(f"   Total Actions: {metrics['actions']['total_actions']}")
                  print(f"   Total Patterns: {metrics['patterns']['total_patterns']}")
                  print(f"   Display Patterns: {metrics['display_patterns']['total_display_patterns']}")

                  # Cleanup old patterns
                  print("\nðŸ§¹ Cleaning up old patterns...")
                  await db.cleanup_old_patterns(days=30)

                  # Optimize database
                  print("âœ¨ Optimizing database...")
                  await db.optimize()

                  # Get behavioral insights
                  print("\nðŸ§  Behavioral Insights:")
                  insights = await db.get_behavioral_insights()
                  print(f"   Most used apps: {len(insights['most_used_apps'])}")
                  print(f"   Common workflows: {len(insights['common_workflows'])}")
                  print(f"   Temporal habits: {len(insights['temporal_habits'])}")
                  print(f"   Prediction accuracy: {insights['prediction_accuracy']:.2%}")

                  await db.close()

                  print("\n" + "=" * 60)
                  print("âœ… Database sync completed successfully!")

              except Exception as e:
                  print(f"âŒ Database sync failed: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)

          if __name__ == "__main__":
              asyncio.run(sync_databases())
          PYTHON_SCRIPT

          # Run sync
          chmod +x sync_databases.py
          venv/bin/python sync_databases.py

          # Backup database
          BACKUP_DIR=~/backend_backups/$(date +%Y%m%d_%H%M%S)
          mkdir -p $BACKUP_DIR

          if [ -d ~/.jarvis/learning ]; then
            echo "ðŸ’¾ Backing up databases..."
            cp -r ~/.jarvis/learning $BACKUP_DIR/
            echo "âœ… Backup saved to $BACKUP_DIR"
          fi

          # Keep only last 7 days of backups
          find ~/backend_backups -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true

          echo "âœ… Sync complete!"
          ENDSSH

      - name: Sync Summary
        if: always()
        run: |
          echo "## ðŸ”„ Database Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** ${{ github.event.inputs.force_full_sync || 'incremental' }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_vm.outputs.vm_exists }}" == "true" ]; then
            echo "- **Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Actions Performed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Aggregated learning data" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Cleaned up old patterns (30+ days)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Optimized database" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Created backup" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** â­ï¸ Skipped (No VMs running)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Info" >> $GITHUB_STEP_SUMMARY
            echo "- No JARVIS VMs currently running" >> $GITHUB_STEP_SUMMARY
            echo "- VMs are created on-demand when needed" >> $GITHUB_STEP_SUMMARY
            echo "- Database sync will run when VM is active" >> $GITHUB_STEP_SUMMARY
          fi

  health-check:
    name: Database Health Check
    runs-on: ubuntu-latest
    needs: sync
    if: needs.sync.outputs.vm_exists == 'true'

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get VM info
        id: vm_info
        run: |
          VM_NAME=$(gcloud compute instances list \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --filter="name~'jarvis-auto-.*' AND status=RUNNING" \
            --format="value(name)" | head -n1)
          VM_ZONE=$(gcloud compute instances list \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --filter="name~'jarvis-auto-.*' AND status=RUNNING" \
            --format="value(zone)" | head -n1)

          echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
          echo "vm_zone=$VM_ZONE" >> $GITHUB_OUTPUT

      - name: Check Database Health
        run: |
          gcloud compute ssh ${{ steps.vm_info.outputs.vm_name }} \
            --zone=${{ steps.vm_info.outputs.vm_zone }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --command='bash -s' <<'ENDSSH'

          echo "ðŸ¥ Running database health check..."

          cd ~/backend/backend

          venv/bin/python -c "
          import asyncio
          import sys
          sys.path.insert(0, '.')

          async def health_check():
              try:
                  from intelligence.learning_database import get_learning_database

                  db = await get_learning_database()
                  metrics = await db.get_learning_metrics()

                  # Check for issues
                  issues = []

                  # Check cache hit rates
                  cache_perf = metrics['cache_performance']
                  if cache_perf['pattern_cache_hit_rate'] < 0.3:
                      issues.append('Low pattern cache hit rate')

                  # Check pattern count
                  if metrics['patterns']['total_patterns'] == 0:
                      issues.append('No patterns learned')

                  if issues:
                      print('âš ï¸  Health check warnings:')
                      for issue in issues:
                          print(f'   - {issue}')
                  else:
                      print('âœ… Database health: GOOD')

                  await db.close()

              except Exception as e:
                  print(f'âŒ Health check failed: {e}')
                  sys.exit(1)

          asyncio.run(health_check())
          "
          ENDSSH

      - name: Health Summary
        run: |
          echo "### ðŸ¥ Health Check" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Database is healthy and operational" >> $GITHUB_STEP_SUMMARY
