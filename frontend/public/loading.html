<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS - System Initialization</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="alternate icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="theme-color" content="#0a0a12" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Matrix Color Palette */
            --matrix-green: #00ff41;
            --matrix-green-dim: #00aa2e;
            --matrix-dark-green: #003300;
            --cyber-cyan: #00d4ff;
            --cyber-cyan-dim: #0099bb;
            --cyber-teal: #00ffcc;
            --panel-bg: rgba(10, 15, 25, 0.85);
            --panel-border: rgba(0, 212, 255, 0.3);
            --panel-border-bright: rgba(0, 212, 255, 0.6);
            --glow-cyan: rgba(0, 212, 255, 0.5);
            --glow-green: rgba(0, 255, 65, 0.4);
            --bg-dark: #0a0a12;
            --text-primary: #e0f7ff;
            --text-secondary: #7fdbff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
        }

        /* Matrix Rain Canvas */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.7;
        }

        /* Glass Panel Container */
        .loading-container {
            position: relative;
            z-index: 10;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 20px;
            padding: 50px 60px;
            min-width: 500px;
            max-width: 600px;
            text-align: center;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow:
                0 0 40px rgba(0, 212, 255, 0.15),
                0 0 80px rgba(0, 212, 255, 0.1),
                inset 0 0 60px rgba(0, 20, 40, 0.3);
        }

        /* Dynamic Title */
        .system-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 8px;
            color: var(--cyber-cyan);
            text-shadow:
                0 0 10px var(--cyber-cyan),
                0 0 20px var(--glow-cyan),
                0 0 40px var(--glow-cyan);
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        /* Circular Progress Container */
        .progress-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 40px;
        }

        /* SVG Progress Circle */
        .progress-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        /* Outer Decorative Ring */
        .ring-outer-deco {
            fill: none;
            stroke: var(--panel-border);
            stroke-width: 1;
            stroke-dasharray: 8 4;
            animation: rotateSlow 30s linear infinite;
            transform-origin: center;
        }

        /* Middle Ring */
        .ring-middle {
            fill: none;
            stroke: var(--cyber-cyan-dim);
            stroke-width: 2;
            opacity: 0.6;
            animation: rotateReverse 20s linear infinite;
            transform-origin: center;
        }

        /* Progress Track */
        .progress-track {
            fill: none;
            stroke: rgba(0, 212, 255, 0.15);
            stroke-width: 8;
            stroke-linecap: round;
        }

        /* Progress Arc */
        .progress-arc {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 0.5s ease-out;
            filter: url(#glowFilter);
        }

        /* Inner Glow Ring */
        .ring-inner-glow {
            fill: none;
            stroke: var(--cyber-cyan);
            stroke-width: 1;
            opacity: 0.4;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        /* Tech Segments on outer ring */
        .tech-segment {
            fill: var(--cyber-cyan);
            opacity: 0.8;
        }

        /* Center Content */
        .progress-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--cyber-cyan);
            text-shadow:
                0 0 20px var(--glow-cyan),
                0 0 40px var(--glow-cyan);
            line-height: 1;
        }

        #subtitle {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            letter-spacing: 2px;
            margin-top: 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        /* Hidden progress bar (for JS compatibility) */
        #progress-bar {
            display: none;
        }

        /* Status Message */
        .status-message {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.1rem;
            color: var(--cyber-teal);
            letter-spacing: 1px;
            text-shadow: 0 0 10px var(--glow-green);
            min-height: 1.5em;
            animation: textPulse 2s ease-in-out infinite;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 20, 30, 0.8);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            z-index: 100;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--matrix-green);
            box-shadow: 0 0 10px var(--matrix-green);
            animation: blink 1.5s ease-in-out infinite;
        }

        .status-indicator.connecting { background: #ffaa00; box-shadow: 0 0 10px #ffaa00; }
        .status-indicator.connected { background: var(--matrix-green); animation: none; }
        .status-indicator.disconnected { background: #ff4444; box-shadow: 0 0 10px #ff4444; }
        .status-indicator.starting { background: #ffaa00; }
        .status-indicator.loading { background: var(--cyber-cyan); }
        .status-indicator.initializing { background: var(--cyber-teal); }
        .status-indicator.verifying { background: var(--cyber-cyan); animation: blink 0.5s infinite; }
        .status-indicator.finalizing { background: var(--matrix-green); animation: blink 0.3s infinite; }
        .status-indicator.ready { background: var(--matrix-green); animation: none; box-shadow: 0 0 15px var(--matrix-green); }
        .status-indicator.error { background: #ff4444; animation: none; }

        #status-text {
            color: var(--text-secondary);
        }

        /* Circuit Board Decoration */
        .circuit-decoration {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 300px;
            height: 200px;
            opacity: 0.3;
            z-index: 5;
            pointer-events: none;
        }

        .circuit-line {
            stroke: var(--cyber-cyan);
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
        }

        .circuit-node {
            fill: var(--cyber-cyan);
        }

        .circuit-pulse {
            animation: circuitPulse 3s ease-in-out infinite;
        }

        /* Error Container */
        .error-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .error-container.visible {
            display: flex;
        }

        .error-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .error-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: #ff4444;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            margin-bottom: 20px;
        }

        .error-message {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            color: #ff8888;
            max-width: 500px;
            text-align: center;
            line-height: 1.6;
        }

        /* Arc Reactor class for JS compatibility */
        .arc-reactor {
            position: relative;
        }

        /* Particles container for JS compatibility */
        #particles {
            display: none;
        }

        /* Animations */
        @keyframes rotateSlow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes rotateReverse {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        @keyframes textPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes circuitPulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.6; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .loading-container {
                min-width: auto;
                width: 90%;
                padding: 30px 25px;
                margin: 20px;
            }

            .system-title {
                font-size: 1.3rem;
                letter-spacing: 4px;
            }

            .progress-circle-container {
                width: 200px;
                height: 200px;
            }

            .progress-percentage {
                font-size: 2.5rem;
            }

            .status-message {
                font-size: 0.9rem;
            }

            .circuit-decoration {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Matrix Rain Canvas -->
    <canvas id="matrix-canvas"></canvas>

    <!-- Circuit Board Decoration -->
    <svg class="circuit-decoration" viewBox="0 0 300 200">
        <defs>
            <filter id="circuitGlow">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        <g filter="url(#circuitGlow)">
            <!-- Horizontal lines -->
            <path class="circuit-line circuit-pulse" d="M0 180 H80 L100 160 H150"/>
            <path class="circuit-line" d="M0 150 H50 L70 130 H120 L140 150 H180" style="animation-delay: 0.5s"/>
            <path class="circuit-line circuit-pulse" d="M0 120 H40 V100 H90 L110 80 H160" style="animation-delay: 1s"/>
            <path class="circuit-line" d="M0 80 H30 L50 60 H100 V40 H140" style="animation-delay: 1.5s"/>

            <!-- Vertical lines -->
            <path class="circuit-line circuit-pulse" d="M60 200 V160 L80 140 V100" style="animation-delay: 0.3s"/>
            <path class="circuit-line" d="M120 200 V170 L140 150 V110 L160 90" style="animation-delay: 0.8s"/>

            <!-- Nodes -->
            <circle class="circuit-node" cx="80" cy="180" r="3"/>
            <circle class="circuit-node" cx="100" cy="160" r="2"/>
            <circle class="circuit-node" cx="150" cy="160" r="3"/>
            <circle class="circuit-node" cx="50" cy="150" r="2"/>
            <circle class="circuit-node" cx="70" cy="130" r="3"/>
            <circle class="circuit-node" cx="180" cy="150" r="2"/>
            <circle class="circuit-node" cx="40" cy="120" r="2"/>
            <circle class="circuit-node" cx="90" cy="100" r="3"/>
            <circle class="circuit-node" cx="160" cy="80" r="2"/>
            <circle class="circuit-node" cx="50" cy="60" r="2"/>
            <circle class="circuit-node" cx="100" cy="40" r="3"/>
            <circle class="circuit-node" cx="140" cy="40" r="2"/>
            <circle class="circuit-node" cx="60" cy="160" r="2"/>
            <circle class="circuit-node" cx="80" cy="140" r="3"/>
            <circle class="circuit-node" cx="120" cy="170" r="2"/>
            <circle class="circuit-node" cx="160" cy="90" r="3"/>
        </g>
    </svg>

    <!-- Connection Status -->
    <div class="connection-status">
        <div class="status-indicator connecting" id="status-indicator"></div>
        <span id="status-text">Connecting...</span>
    </div>

    <!-- Main Loading Container -->
    <div class="loading-container">
        <!-- Dynamic Title -->
        <h1 class="system-title" id="system-title">SYSTEM RESTART</h1>

        <!-- Circular Progress Indicator -->
        <div class="progress-circle-container arc-reactor">
            <svg class="progress-svg" viewBox="0 0 280 280">
                <defs>
                    <!-- Gradient for progress arc -->
                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#00ffcc;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#00d4ff;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#00ff88;stop-opacity:1" />
                    </linearGradient>
                    <!-- Glow filter -->
                    <filter id="glowFilter" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>

                <!-- Outer Decorative Ring with tech segments -->
                <circle class="ring-outer-deco" cx="140" cy="140" r="135"/>

                <!-- Tech segment markers around outer ring -->
                <g id="tech-segments">
                    <rect class="tech-segment" x="137" y="2" width="6" height="12" rx="1"/>
                    <rect class="tech-segment" x="137" y="266" width="6" height="12" rx="1"/>
                    <rect class="tech-segment" x="2" y="137" width="12" height="6" rx="1"/>
                    <rect class="tech-segment" x="266" y="137" width="12" height="6" rx="1"/>
                    <!-- Diagonal markers -->
                    <rect class="tech-segment" x="232" y="42" width="8" height="4" rx="1" transform="rotate(45 236 44)"/>
                    <rect class="tech-segment" x="42" y="232" width="8" height="4" rx="1" transform="rotate(45 46 234)"/>
                    <rect class="tech-segment" x="42" y="42" width="8" height="4" rx="1" transform="rotate(-45 46 44)"/>
                    <rect class="tech-segment" x="232" y="232" width="8" height="4" rx="1" transform="rotate(-45 236 234)"/>
                </g>

                <!-- Middle Ring -->
                <circle class="ring-middle" cx="140" cy="140" r="115"/>

                <!-- Progress Track -->
                <circle class="progress-track" cx="140" cy="140" r="90"/>

                <!-- Progress Arc -->
                <circle class="progress-arc" id="progress-circle" cx="140" cy="140" r="90"/>

                <!-- Inner Glow Ring -->
                <circle class="ring-inner-glow" cx="140" cy="140" r="65"/>
            </svg>

            <!-- Center Content -->
            <div class="progress-center">
                <div class="progress-percentage" id="progress-percentage">0%</div>
                <div id="subtitle">INITIALIZING</div>
            </div>
        </div>

        <!-- Hidden progress bar for JS compatibility -->
        <div id="progress-bar" style="width: 0%;"></div>

        <!-- Status Message -->
        <div class="status-message" id="status-message">Initializing JARVIS systems...</div>
    </div>

    <!-- Error Container -->
    <div class="error-container" id="error-container">
        <div class="error-icon">⚠️</div>
        <div class="error-title">SYSTEM FAILURE</div>
        <div class="error-message" id="error-message">An error occurred during initialization.</div>
    </div>

    <!-- Hidden particles div for JS compatibility -->
    <div id="particles"></div>

    <!-- Matrix Rain Animation Script -->
    <script>
        class MatrixRain {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.columns = [];
                this.fontSize = 14;
                this.characters = '01';
                this.init();
                this.animate();

                window.addEventListener('resize', () => this.init());
            }

            init() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                const columnCount = Math.floor(this.canvas.width / this.fontSize);
                this.columns = [];

                for (let i = 0; i < columnCount; i++) {
                    this.columns.push({
                        x: i * this.fontSize,
                        y: Math.random() * this.canvas.height,
                        speed: Math.random() * 2 + 1,
                        chars: [],
                        length: Math.floor(Math.random() * 15) + 5
                    });

                    // Initialize character array for this column
                    for (let j = 0; j < this.columns[i].length; j++) {
                        this.columns[i].chars.push({
                            char: this.getRandomChar(),
                            opacity: 1 - (j / this.columns[i].length)
                        });
                    }
                }
            }

            getRandomChar() {
                return this.characters[Math.floor(Math.random() * this.characters.length)];
            }

            draw() {
                // Semi-transparent black to create trail effect
                this.ctx.fillStyle = 'rgba(10, 10, 18, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.font = `${this.fontSize}px 'Share Tech Mono', monospace`;

                for (let col of this.columns) {
                    // Draw each character in the column
                    for (let i = 0; i < col.chars.length; i++) {
                        const y = col.y - (i * this.fontSize);

                        if (y < -this.fontSize * col.length) continue;
                        if (y > this.canvas.height + this.fontSize) continue;

                        // First character is brightest (head of the trail)
                        if (i === 0) {
                            this.ctx.fillStyle = '#ffffff';
                            this.ctx.shadowBlur = 10;
                            this.ctx.shadowColor = '#00ff41';
                        } else {
                            const opacity = col.chars[i].opacity * 0.8;
                            this.ctx.fillStyle = `rgba(0, 255, 65, ${opacity})`;
                            this.ctx.shadowBlur = 0;
                        }

                        this.ctx.fillText(col.chars[i].char, col.x, y);

                        // Randomly change character
                        if (Math.random() < 0.02) {
                            col.chars[i].char = this.getRandomChar();
                        }
                    }

                    // Move column down
                    col.y += col.speed;

                    // Reset when off screen
                    if (col.y - (col.length * this.fontSize) > this.canvas.height) {
                        col.y = 0;
                        col.speed = Math.random() * 2 + 1;
                        col.length = Math.floor(Math.random() * 15) + 5;

                        // Reset characters
                        col.chars = [];
                        for (let j = 0; j < col.length; j++) {
                            col.chars.push({
                                char: this.getRandomChar(),
                                opacity: 1 - (j / col.length)
                            });
                        }
                    }
                }
            }

            animate() {
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // Initialize Matrix Rain
        const matrixCanvas = document.getElementById('matrix-canvas');
        const matrixRain = new MatrixRain(matrixCanvas);

        // Progress circle animation helper
        function updateProgressCircle(percentage) {
            const circle = document.getElementById('progress-circle');
            if (circle) {
                const circumference = 2 * Math.PI * 90; // r = 90
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        }

        // Update title based on URL or startup type
        function updateDynamicTitle() {
            const title = document.getElementById('system-title');
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');

            if (mode === 'restart' || window.location.href.includes('restart')) {
                title.textContent = 'SYSTEM RESTART';
            } else if (mode === 'init' || mode === 'fresh') {
                title.textContent = 'SYSTEM INITIALIZATION';
            } else {
                // Default - check subtitle for context
                title.textContent = 'SYSTEM STARTUP';
            }
        }

        // Hook into the loading manager's progress updates
        const originalSetAttribute = Element.prototype.setAttribute;
        const progressPercentageEl = document.getElementById('progress-percentage');

        // Create a MutationObserver to watch for style changes on progress-bar
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const width = progressBar.style.width;
                        if (width) {
                            const percentage = parseFloat(width);
                            if (!isNaN(percentage)) {
                                updateProgressCircle(percentage);
                            }
                        }
                    }
                });
            });

            observer.observe(progressBar, { attributes: true });
        }

        // Also watch the percentage text element for direct updates
        if (progressPercentageEl) {
            const textObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const text = progressPercentageEl.textContent;
                        const match = text.match(/(\d+)/);
                        if (match) {
                            const percentage = parseInt(match[1]);
                            updateProgressCircle(percentage);
                        }
                    }
                });
            });

            textObserver.observe(progressPercentageEl, {
                childList: true,
                characterData: true,
                subtree: true
            });
        }

        // Initialize
        updateDynamicTitle();
    </script>

    <!-- Loading Manager Script -->
    <script src="/loading-manager.js"></script>
</body>
</html>
