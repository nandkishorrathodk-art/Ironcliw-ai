<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS - System Initialization</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#0a0a12" />
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00ffff;
            --neon-green: #00ff41;
            --glow-cyan: rgba(0, 255, 255, 0.8);
            --glow-green: rgba(0, 255, 65, 0.8);
            --bg-dark: #0a0a12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
        }

        body {
            font-family: 'Orbitron', sans-serif;
        }

        /* Main Container with Background Image */
        .loading-screen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('matrix-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                filter: brightness(1) drop-shadow(0 0 10px rgba(0, 255, 255, 0.3));
            }

            50% {
                filter: brightness(1.15) drop-shadow(0 0 40px rgba(0, 255, 255, 0.6));
            }
        }

        /* Dynamic Text Overlay Container - positioned relative to image */
        .dynamic-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            /* Adjust these to fine-tune position over the ring */
            margin-top: -15px;
        }

        /* Percentage Display - Positioned at center of ring */
        #dynamic-percentage {
            font-family: 'Orbitron', monospace;
            font-size: 4rem;
            font-weight: 700;
            color: var(--neon-green);
            text-shadow:
                0 0 10px var(--glow-green),
                0 0 20px var(--glow-green),
                0 0 40px var(--glow-green),
                0 0 80px var(--glow-green);
            letter-spacing: 0.05em;
        }

        #dynamic-percentage.success {
            color: #00ff41;
            text-shadow: 0 0 30px #00ff41, 0 0 60px #00ff41;
        }

        /* Subtitle under percentage */
        #dynamic-subtitle {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--neon-cyan);
            letter-spacing: 3px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Status Text - Below the ring */
        #dynamic-status {
            position: absolute;
            top: 68%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--neon-green);
            text-shadow:
                0 0 5px var(--glow-green),
                0 0 15px var(--glow-green);
            letter-spacing: 0.1em;
            white-space: nowrap;
        }

        /* Title - "SYSTEM RESTART" - positioned at top of the panel */
        #dynamic-title {
            position: absolute;
            top: 26%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--neon-cyan);
            text-shadow:
                0 0 10px var(--glow-cyan),
                0 0 20px var(--glow-cyan),
                0 0 40px var(--glow-cyan);
            letter-spacing: 0.4em;
            text-transform: uppercase;
        }

        /* Connection Status Indicator */
        .conn-status {
            position: fixed;
            top: 18px;
            right: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 14px;
            background: rgba(0, 20, 30, 0.85);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--neon-cyan);
            z-index: 100;
        }

        .conn-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ffaa00;
            box-shadow: 0 0 6px #ffaa00;
        }

        .conn-dot.connected {
            background: var(--neon-green);
            box-shadow: 0 0 6px var(--neon-green);
        }

        /* Error State */
        .error-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(20, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .error-overlay.visible {
            display: flex;
        }

        .error-title {
            font-size: 1.8rem;
            color: #ff4444;
            margin-bottom: 15px;
        }

        .error-msg {
            font-family: 'Share Tech Mono', monospace;
            color: #ff8888;
            max-width: 450px;
            text-align: center;
        }

        /* Transition overlay for warp effect */
        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, transparent 0%, #000 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 200;
            transition: opacity 0.8s ease-in;
        }

        .transition-overlay.active {
            opacity: 1;
        }

        /* Hidden elements for JS compatibility with loading-manager.js */
        #progress-bar {
            display: none;
        }

        #particles {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Connection Status -->
    <div class="conn-status">
        <div class="conn-dot" id="status-indicator"></div>
        <span id="status-text">Connecting...</span>
    </div>

    <!-- Main Loading Screen Container with Background Image -->
    <div class="loading-screen-container" id="loading-container">
        <!-- Title -->
        <h2 id="dynamic-title">SYSTEM RESTART</h2>

        <!-- Dynamic Overlay for Percentage -->
        <div class="dynamic-overlay">
            <h1 id="dynamic-percentage">0%</h1>
            <div id="dynamic-subtitle">INITIALIZING</div>
        </div>

        <!-- Status Text -->
        <p id="dynamic-status">Loading Modules...</p>
    </div>

    <!-- Hidden elements for loading-manager.js compatibility -->
    <div id="progress-bar" style="width:0%"></div>
    <div id="progress-percentage" style="display:none;">0%</div>
    <div id="status-message" style="display:none;">Loading...</div>
    <div id="particles"></div>

    <!-- Error Overlay -->
    <div class="error-overlay" id="error-container">
        <div class="error-title">SYSTEM FAILURE</div>
        <div class="error-msg" id="error-message">An error occurred.</div>
    </div>

    <!-- Transition Overlay -->
    <div class="transition-overlay" id="transition-overlay"></div>

    <script>
        // =====================================================
        // Dynamic Title based on URL params
        // =====================================================
        function setTitle() {
            const t = document.getElementById('dynamic-title');
            const p = new URLSearchParams(location.search);
            const m = p.get('mode');
            if (m === 'restart' || location.href.includes('restart')) t.textContent = 'SYSTEM RESTART';
            else if (m === 'init') t.textContent = 'SYSTEM INITIALIZATION';
            else t.textContent = 'SYSTEM STARTUP';
        }

        // =====================================================
        // Success State
        // =====================================================
        let successDone = false;
        function triggerSuccessState() {
            if (successDone) return Promise.resolve();
            successDone = true;
            return new Promise(res => {
                const pct = document.getElementById('dynamic-percentage');
                const title = document.getElementById('dynamic-title');
                const status = document.getElementById('dynamic-status');
                const subtitle = document.getElementById('dynamic-subtitle');

                if (pct) pct.classList.add('success');
                if (title) {
                    title.textContent = 'ACCESS GRANTED';
                    title.style.color = '#00ff41';
                }
                if (status) status.textContent = 'System Ready';
                if (subtitle) subtitle.textContent = 'COMPLETE';

                setTimeout(res, 800);
            });
        }
        window.triggerSuccessState = triggerSuccessState;

        // =====================================================
        // Observers for loading-manager.js compatibility
        // =====================================================
        function setupObservers() {
            const hiddenPct = document.getElementById('progress-percentage');
            const hiddenMsg = document.getElementById('status-message');
            const bar = document.getElementById('progress-bar');

            const displayPct = document.getElementById('dynamic-percentage');
            const displayStatus = document.getElementById('dynamic-status');

            // Observe hidden percentage and sync to visible element
            if (hiddenPct && displayPct) {
                new MutationObserver(() => {
                    const t = hiddenPct.textContent;
                    displayPct.textContent = t;
                    const match = t.match(/(\d+)/);
                    if (match) {
                        const v = parseInt(match[1]);
                        if (v >= 100 && !successDone) triggerSuccessState();
                    }
                }).observe(hiddenPct, { childList: true, characterData: true, subtree: true });
            }

            // Observe hidden message and sync to visible element
            if (hiddenMsg && displayStatus) {
                new MutationObserver(() => {
                    displayStatus.textContent = hiddenMsg.textContent;
                }).observe(hiddenMsg, { childList: true, characterData: true, subtree: true });
            }

            // Observe progress bar width
            if (bar && displayPct) {
                new MutationObserver(ms => {
                    ms.forEach(m => {
                        if (m.attributeName === 'style') {
                            const w = bar.style.width;
                            const v = parseFloat(w);
                            if (!isNaN(v)) {
                                displayPct.textContent = Math.round(v) + '%';
                                if (v >= 100 && !successDone) triggerSuccessState();
                            }
                        }
                    });
                }).observe(bar, { attributes: true });
            }
        }

        // =====================================================
        // Transition Effect
        // =====================================================
        function triggerTransition(redirectUrl) {
            const overlay = document.getElementById('transition-overlay');
            const container = document.getElementById('loading-container');

            if (overlay) overlay.classList.add('active');
            if (container) {
                container.style.animation = 'none';
                container.style.transition = 'transform 0.8s ease-in, filter 0.8s ease-in';
                container.style.transform = 'scale(1.3)';
                container.style.filter = 'brightness(2) blur(8px)';
            }

            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1000);
        }
        window.triggerTransition = triggerTransition;

        // =====================================================
        // Init
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            setTitle();
            setupObservers();
        });
    </script>

    <script src="/loading-manager.js"></script>
</body>

</html>